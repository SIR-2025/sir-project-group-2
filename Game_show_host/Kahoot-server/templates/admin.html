<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - {{ quiz_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="admin-page">
    
    <!-- Header -->
    <div class="header">
        <h1>üéÆ {{ quiz_title }}</h1>
        <p class="subtitle">Admin Dashboard</p>
    </div>

    <!-- Main Container -->
    <div class="container">
        
        <!-- Status Panel -->
        <div class="panel">
            <h2>üìä Quiz Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Status</div>
                    <div class="status-value" id="quiz-status">Waiting...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Current Question</div>
                    <div class="status-value" id="current-question">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Total Questions</div>
                    <div class="status-value">{{ total_questions }}</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Players</div>
                    <div class="status-value" id="player-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Answered</div>
                    <div class="status-value" id="answered-count">0</div>
                </div>
            </div>
        </div>

        <!-- Player List Panel -->
        <div class="panel">
            <h2>üë• Players</h2>
            <div id="player-list" class="player-list">
                <p class="empty-state">No players yet. Share the QR code below!</p>
            </div>
        </div>

        <!-- QR Code Panel -->
        <div class="panel qr-panel">
            <h2>üì± Join Quiz</h2>
            <p>Scan this QR code or visit:</p>
            <div class="qr-code-container">
                <img src="{{ qr_code }}" alt="QR Code" class="qr-code">
            </div>
            <div class="join-url">
                <code>{{ join_url }}</code>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="panel">
            <h2>üéõÔ∏è Controls</h2>
            <p class="info-text">
                The Nao robot controls the quiz flow via API.<br>
                These buttons are for manual testing only.
            </p>
            <div class="button-grid">
                <button onclick="startQuiz()" class="btn btn-success">‚ñ∂Ô∏è Start Quiz</button>
                <button onclick="nextQuestion()" class="btn btn-primary">‚è≠Ô∏è Next Question</button>
                <button onclick="resetQuiz()" class="btn btn-danger">üîÑ Reset Quiz</button>
            </div>
        </div>

    </div>

    <!-- JavaScript -->
    <script>
        // ========================================
        // Configuration
        // ========================================
        
        const API_BASE = window.location.origin;
        const POLL_INTERVAL = 2000; // Poll every 2 seconds

        // ========================================
        // Status Update Function
        // ========================================
        
        async function updateStatus() {
            try {
                // Fetch status from API
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                
                // Update status display
                document.getElementById('quiz-status').textContent = 
                    data.is_active ? 'üü¢ Active' : 'üî¥ Inactive';
                
                // Update question counter
                if (data.current_question >= 0) {
                    document.getElementById('current-question').textContent = 
                        `${data.current_question + 1} / ${data.total_questions}`;
                } else {
                    document.getElementById('current-question').textContent = '-';
                }
                
                // Update player counts
                document.getElementById('player-count').textContent = data.player_count;
                document.getElementById('answered-count').textContent = data.answered_count;
                
            } catch (error) {
                console.error('Error updating status:', error);
                document.getElementById('quiz-status').textContent = '‚ö†Ô∏è Error';
            }
        }

        // ========================================
        // Manual Control Functions
        // ========================================
        
        async function startQuiz() {
            try {
                const response = await fetch(`${API_BASE}/api/start`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || 'Quiz started!');
                updateStatus();
            } catch (error) {
                console.error('Error starting quiz:', error);
                alert('Error starting quiz');
            }
        }

        async function nextQuestion() {
            try {
                const response = await fetch(`${API_BASE}/api/next`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || 'Next question');
                updateStatus();
            } catch (error) {
                console.error('Error going to next question:', error);
                alert('Error going to next question');
            }
        }

        async function resetQuiz() {
            if (!confirm('Are you sure you want to reset the quiz? This will remove all players and answers.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/reset`, {
                    method: 'POST'
                });
                const data = await response.json();
                alert(data.message || 'Quiz reset!');
                updateStatus();
            } catch (error) {
                console.error('Error resetting quiz:', error);
                alert('Error resetting quiz');
            }
        }

        // ========================================
        // Initialization
        // ========================================
        
        // Initial status update
        updateStatus();
        
        // Start polling for status updates
        setInterval(updateStatus, POLL_INTERVAL);
        
        console.log('Admin dashboard initialized');
    </script>

</body>
</html>

