<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play - {{ quiz_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="play-page">
    
    <!-- Header -->
    <div class="header">
        <h1>üéÆ {{ quiz_title }}</h1>
        <p class="player-name">Player: <strong>{{ player_name }}</strong></p>
    </div>

    <!-- Main Container -->
    <div class="container">
        
        <!-- Waiting State -->
        <div id="waiting-state" class="state-panel">
            <div class="waiting-content">
                <div class="spinner"></div>
                <h2>‚è≥ Waiting for quiz to start...</h2>
                <p>The quiz master will start the quiz soon.</p>
            </div>
        </div>

        <!-- Question State -->
        <div id="question-state" class="state-panel hidden">
            
            <!-- Question Header -->
            <div class="question-header">
                <div class="question-number" id="question-number">Question 1</div>
            </div>

            <!-- Question Text -->
            <div class="question-text" id="question-text">
                Loading question...
            </div>

            <!-- Answer Options -->
            <div class="answer-grid" id="answer-grid">
                <!-- Options will be generated by JavaScript -->
            </div>

            <!-- Answer Feedback -->
            <div id="answer-feedback" class="answer-feedback hidden">
                <p>‚úÖ Answer submitted! Waiting for next question...</p>
            </div>

        </div>

        <!-- Quiz Finished State -->
        <div id="finished-state" class="state-panel hidden">
            <div class="finished-content">
                <h2>üéâ Quiz Finished!</h2>
                <p>Thank you for playing!</p>
                <p class="info-text">The quiz master will announce the results.</p>
            </div>
        </div>

    </div>

    <!-- JavaScript -->
    <script>
        // ========================================
        // Configuration
        // ========================================
        
        const API_BASE = window.location.origin;
        const POLL_INTERVAL = 2000; // Poll every 2 seconds
        const PLAYER_ID = "{{ player_id }}";
        
        // State variables
        let currentQuestionIndex = -1;
        let hasAnswered = false;

        // ========================================
        // State Management Functions
        // ========================================
        
        function showState(stateName) {
            // Hide all states
            document.getElementById('waiting-state').classList.add('hidden');
            document.getElementById('question-state').classList.add('hidden');
            document.getElementById('finished-state').classList.add('hidden');
            
            // Show requested state
            document.getElementById(stateName).classList.remove('hidden');
        }

        // ========================================
        // Question Display Functions
        // ========================================
        
        function displayQuestion(questionData, questionNumber) {
            // Update question number
            document.getElementById('question-number').textContent = 
                `Question ${questionNumber}`;
            
            // Update question text
            document.getElementById('question-text').textContent = questionData.text;
            
            // Generate answer options
            const answerGrid = document.getElementById('answer-grid');
            answerGrid.innerHTML = '';
            
            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'answer-option';
                button.textContent = option;
                button.onclick = () => submitAnswer(index);
                answerGrid.appendChild(button);
            });
            
            // Reset answer feedback
            document.getElementById('answer-feedback').classList.add('hidden');
            hasAnswered = false;
        }

        // ========================================
        // Answer Submission
        // ========================================
        
        async function submitAnswer(answerIndex) {
            // Prevent double submission
            if (hasAnswered) {
                return;
            }
            
            try {
                // Send answer to API
                const response = await fetch(`${API_BASE}/api/player/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_id: PLAYER_ID,
                        answer: answerIndex
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to submit answer');
                }
                
                // Mark as answered
                hasAnswered = true;
                
                // Highlight selected answer
                const answerButtons = document.querySelectorAll('.answer-option');
                answerButtons.forEach((btn, idx) => {
                    if (idx === answerIndex) {
                        btn.classList.add('selected');
                    }
                    btn.disabled = true;
                });
                
                // Show feedback
                document.getElementById('answer-feedback').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Error submitting answer. Please try again.');
            }
        }

        // ========================================
        // Status Polling
        // ========================================
        
        async function checkStatus() {
            try {
                // Fetch status from API
                const response = await fetch(
                    `${API_BASE}/api/player/status?player_id=${PLAYER_ID}`
                );
                const data = await response.json();
                
                // Handle quiz states
                if (!data.is_active && data.current_question === -1) {
                    // Quiz not started yet
                    showState('waiting-state');
                    currentQuestionIndex = -1;
                    
                } else if (!data.is_active && data.current_question >= 0) {
                    // Quiz finished
                    showState('finished-state');
                    
                } else if (data.is_active && data.question_data) {
                    // Quiz is active, show question
                    
                    // Check if this is a new question
                    if (data.current_question !== currentQuestionIndex) {
                        currentQuestionIndex = data.current_question;
                        displayQuestion(data.question_data, data.current_question + 1);
                        showState('question-state');
                    }
                    
                    // Update answered status if needed
                    if (data.has_answered && !hasAnswered) {
                        hasAnswered = true;
                        document.getElementById('answer-feedback').classList.remove('hidden');
                    }
                }
                
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        // ========================================
        // Initialization
        // ========================================
        
        // Validate player ID
        if (!PLAYER_ID || PLAYER_ID === '') {
            alert('Invalid player ID. Please join the quiz again.');
            window.location.href = `${API_BASE}/join`;
        }
        
        // Initial status check
        checkStatus();
        
        // Start polling for status updates
        setInterval(checkStatus, POLL_INTERVAL);
        
        console.log('Play page initialized for player:', PLAYER_ID);
    </script>

</body>
</html>

