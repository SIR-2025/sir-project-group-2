<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - {{ quiz_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="admin-page">
    
    <!-- Header -->
    <div class="header">
        <h1>üéÆ {{ quiz_title }}</h1>
        <p class="subtitle">Admin Dashboard</p>
    </div>

    <!-- Main Container -->
    <div class="container">
        
        <!-- Status Panel -->
        <div class="panel">
            <h2>üìä Quiz Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Phase</div>
                    <div class="status-value" id="quiz-phase">waiting</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Question</div>
                    <div class="status-value" id="current-question">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Total</div>
                    <div class="status-value">{{ total_questions }}</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Players</div>
                    <div class="status-value" id="player-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Answered</div>
                    <div class="status-value" id="answered-count">0</div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="panel">
            <h2>üéõÔ∏è Quiz Flow Controls</h2>
            <p class="info-text">Test the quiz flow (same as Nao API calls)</p>
            
            <div class="control-flow">
                <button onclick="startQuiz()" class="btn btn-success" id="btn-start">
                    1. ‚ñ∂Ô∏è Start Quiz
                </button>
                <button onclick="revealOptions()" class="btn btn-primary" id="btn-reveal">
                    2. üëÅÔ∏è Reveal Options
                </button>
                <button onclick="showAnswers()" class="btn btn-primary" id="btn-answers">
                    3. üìä Show Answers
                </button>
                <button onclick="showLeaderboard()" class="btn btn-primary" id="btn-leaderboard">
                    4. üèÜ Show Leaderboard
                </button>
                <button onclick="nextQuestion()" class="btn btn-primary" id="btn-next">
                    5. ‚è≠Ô∏è Next Question
                </button>
            </div>
            
            <hr style="margin: 1.5rem 0; border-color: #eee;">
            
            <button onclick="resetQuiz()" class="btn btn-danger">üîÑ Reset Quiz</button>
        </div>

        <!-- QR Code Panel -->
        <div class="panel qr-panel">
            <h2>üì± Join Quiz</h2>
            <p>Scan QR code or visit:</p>
            <div class="qr-code-container">
                <img src="{{ qr_code }}" alt="QR Code" class="qr-code">
            </div>
            <div class="join-url">
                <code>{{ join_url }}</code>
            </div>
        </div>

        <!-- Player List Panel -->
        <div class="panel">
            <h2>üë• Players</h2>
            <div id="player-list" class="player-list">
                <p class="empty-state">No players yet</p>
            </div>
        </div>

    </div>

    <style>
        .control-flow {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .control-flow .btn {
            flex: 1;
            min-width: 150px;
        }
        .btn.active {
            box-shadow: 0 0 0 3px #46178F;
        }
    </style>

    <script>
        const API_BASE = window.location.origin;
        const POLL_INTERVAL = 1000;
        
        // Update status display
        async function updateStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                
                document.getElementById('quiz-phase').textContent = data.phase || 'waiting';
                document.getElementById('player-count').textContent = data.player_count;
                document.getElementById('answered-count').textContent = data.answered_count;
                
                if (data.current_question >= 0) {
                    document.getElementById('current-question').textContent = 
                        `${data.current_question + 1} / ${data.total_questions}`;
                } else {
                    document.getElementById('current-question').textContent = '-';
                }
                
                // Highlight current phase button
                highlightPhaseButton(data.phase);
                
            } catch (error) {
                console.error('Status error:', error);
            }
        }
        
        function highlightPhaseButton(phase) {
            document.querySelectorAll('.control-flow .btn').forEach(b => b.classList.remove('active'));
            const mapping = {
                'waiting': 'btn-start',
                'question': 'btn-reveal',
                'answering': 'btn-answers',
                'results': 'btn-leaderboard',
                'leaderboard': 'btn-next'
            };
            const btnId = mapping[phase];
            if (btnId) document.getElementById(btnId).classList.add('active');
        }
        
        // API calls
        async function apiCall(endpoint, method = 'POST') {
            try {
                const response = await fetch(`${API_BASE}/api/${endpoint}`, { method });
                const data = await response.json();
                console.log(`${endpoint}:`, data);
                updateStatus();
                return data;
            } catch (error) {
                console.error(`Error ${endpoint}:`, error);
                alert(`Error: ${endpoint}`);
            }
        }
        
        function startQuiz() { apiCall('start'); }
        function revealOptions() { apiCall('reveal_options'); }
        function showAnswers() { apiCall('show_answers'); }
        function showLeaderboard() { apiCall('show_leaderboard'); }
        function nextQuestion() { apiCall('next'); }
        function resetQuiz() {
            if (confirm('Reset quiz and remove all players?')) {
                apiCall('reset');
            }
        }
        
        // Initialize
        updateStatus();
        setInterval(updateStatus, POLL_INTERVAL);
    </script>

</body>
</html>
