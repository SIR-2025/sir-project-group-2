<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play - {{ quiz_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="play-page">
    
    <!-- Header -->
    <div class="header">
        <h1>üéÆ {{ quiz_title }}</h1>
        <p class="player-name">Player: <strong>{{ player_name }}</strong></p>
        <p class="score-display">Score: <strong id="player-score">0</strong></p>
    </div>

    <!-- Main Container -->
    <div class="container">
        
        <!-- Waiting State -->
        <div id="waiting-state" class="state-panel">
            <div class="waiting-content">
                <div class="spinner"></div>
                <h2>‚è≥ Waiting for quiz to start...</h2>
                <p>The quiz master will start the quiz soon.</p>
            </div>
        </div>

        <!-- Question Coming State -->
        <div id="question-coming-state" class="state-panel hidden">
            <div class="waiting-content">
                <h2>üì£ Get Ready!</h2>
                <p>Listen to the question...</p>
            </div>
        </div>

        <!-- Answer State (Kahoot colors) -->
        <div id="answer-state" class="state-panel hidden">
            <div class="kahoot-answer-grid" id="kahoot-answers">
                <!-- Kahoot buttons inserted by JS -->
            </div>
        </div>

        <!-- Answered State -->
        <div id="answered-state" class="state-panel hidden">
            <div class="waiting-content">
                <h2>‚úÖ Answer submitted!</h2>
                <p>Waiting for results...</p>
            </div>
        </div>

        <!-- Results State -->
        <div id="results-state" class="state-panel hidden">
            <div class="waiting-content">
                <h2>üìä Look at the screen!</h2>
                <p>Results are being shown...</p>
            </div>
        </div>

        <!-- Quiz Finished State -->
        <div id="finished-state" class="state-panel hidden">
            <div class="finished-content">
                <h2>üéâ Quiz Finished!</h2>
                <p>Final score: <strong id="final-score">0</strong></p>
            </div>
        </div>

    </div>

    <script>
        const API_BASE = window.location.origin;
        const POLL_INTERVAL = 500;
        const PLAYER_ID = "{{ player_id }}";
        const KAHOOT_COLORS = ['#E21B3C', '#1368CE', '#D89E00', '#26890C'];
        const KAHOOT_SHAPES = ['‚ñ≤', '‚óÜ', '‚óè', '‚ñ†'];
        
        let currentPhase = '';
        let currentQuestion = -1;
        let hasAnswered = false;

        // Show specific state
        function showState(stateId) {
            document.querySelectorAll('.state-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(stateId).classList.remove('hidden');
        }

        // Render Kahoot answer buttons
        function renderAnswerButtons(options) {
            const grid = document.getElementById('kahoot-answers');
            grid.innerHTML = options.map((opt, i) => `
                <button class="kahoot-btn" style="background-color: ${KAHOOT_COLORS[i]}" onclick="submitAnswer(${i})">
                    <span class="btn-shape">${KAHOOT_SHAPES[i]}</span>
                </button>
            `).join('');
        }

        // Submit answer
        async function submitAnswer(answerIndex) {
            if (hasAnswered) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/player/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: PLAYER_ID, answer: answerIndex })
                });
                
                if (response.ok) {
                    hasAnswered = true;
                    // Highlight selected
                    document.querySelectorAll('.kahoot-btn').forEach((btn, idx) => {
                        if (idx === answerIndex) btn.classList.add('selected');
                        btn.disabled = true;
                    });
                    showState('answered-state');
                }
            } catch (error) {
                console.error('Submit error:', error);
            }
        }

        // Poll for status
        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/player/status?player_id=${PLAYER_ID}`);
                const data = await response.json();
                
                // Update score
                document.getElementById('player-score').textContent = data.score || 0;
                document.getElementById('final-score').textContent = data.score || 0;

                // Handle phase/question changes
                const phaseChanged = data.phase !== currentPhase;
                const questionChanged = data.current_question !== currentQuestion;
                
                if (questionChanged) {
                    currentQuestion = data.current_question;
                    hasAnswered = false;
                }
                
                if (phaseChanged || questionChanged) {
                    currentPhase = data.phase;
                    
                    if (!data.is_active && currentQuestion === -1) {
                        showState('waiting-state');
                    } else if (!data.is_active && currentQuestion >= 0) {
                        showState('finished-state');
                    } else if (data.phase === 'question') {
                        showState('question-coming-state');
                    } else if (data.phase === 'answering' && !hasAnswered) {
                        renderAnswerButtons(data.question_data?.options || []);
                        showState('answer-state');
                    } else if (data.phase === 'results' || data.phase === 'leaderboard') {
                        showState('results-state');
                    }
                }
                
                // Check if already answered
                if (data.has_answered && !hasAnswered) {
                    hasAnswered = true;
                    showState('answered-state');
                }
                
            } catch (error) {
                console.error('Status error:', error);
            }
        }

        // Validate player
        if (!PLAYER_ID || PLAYER_ID === '') {
            alert('Invalid player ID. Please join again.');
            window.location.href = `${API_BASE}/join`;
        }

        // Start polling
        checkStatus();
        setInterval(checkStatus, POLL_INTERVAL);
    </script>
</body>
</html>
